<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FFD339">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&display=swap" rel="stylesheet">

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
  <link rel="manifest" href="/site.webmanifest" />

  <title>Play Bee</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      font-family: 'Be Vietnam Pro', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --black: #000000;
      --white: #ffffff;
      --gray: #E5E5E5;
      --yellow: #FFD339;
      --yellow-text: #FFC93E;
    }

    body {
      display: grid;
      place-content: center;

      margin: 0;
      padding: 0;

      font-size: 1rem;
    }

    h1, h2, h3, h4, h5, h6 {
      margin: 0;
    }
    h1 {
      font-size: 1.375rem;
      font-weight: 900;
      line-height: 2rem;
    }

    .dialog {
      appearance: none;
      border: none;
      outline: none;

      margin: 0;
      padding: 0;

      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;

      font-size: 0.75rem;
    }
    .dialog[open] {
      display: flex;
      flex-flow: column nowrap;
    }

    .two-pane {
      height: 100%;
      overflow-y: auto;

      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
    }
    .two-pane-pane {
      display: flex;
      flex-flow: column nowrap;
      gap: 1rem;
    }
    .two-pane-pane-inner span {
      border-radius: 0.5rem;
      padding: 0.375rem 0.5rem;
      white-space: nowrap;
    }

    .button {
      appearance: none;
      border: none;
      outline: none;

      border-radius: 0.5rem;
      color: var(--black);
      cursor: pointer;
      font-size: 1rem;
      padding: 0.375rem 0.5rem;
    }
    .button.small {
      font-size: 0.75rem;
    }
    .button svg {
      display: block;
    }
    
    .gray {
      background-color: var(--gray);
    }
    .white {
      background-color: var(--white);
    }
    .yellow {
      background-color: var(--yellow);
    }
    .yellow-color {
      color: var(--yellow);
    }

    .nav {
      width: 100%;
      padding: 1rem;

      display: flex;
      flex-flow: row nowrap;
      align-items: center;
      justify-content: space-between;
    }

    .icon-group {
      display: flex;
      flex-flow: row nowrap;
      align-items: center;
      gap: 0.375rem;
    }

    main#container {
      width: 100vw;
      height: 100vh;

      display: flex;
      flex-flow: column nowrap;
    }

    nav.nav {
      background-color: var(--yellow);
    }

    header#score {
      font-size: 0.75rem;
      width: 100%;
      padding: 1rem;

      display: flex;
      flex-flow: row nowrap;
      align-items: center;
      justify-content: space-between;
    }

    section#game {
      width: 100%;
      flex-grow: 1;

      display: grid;
      grid-template-rows: 2fr auto 3fr;
    }

    div#input {
      position: relative;
      
      padding-bottom: 1rem;
    }

    span#feedback {
      position: absolute;
      left: 50%;
      bottom: 3.5rem;

      transform: translateX(-50%);

      white-space: nowrap;
      text-overflow: ellipsis;
    }

    span#current-word {
      position: absolute;
      left: 50%;
      bottom: 1rem;

      transform: translateX(-50%);

      font-size: 2rem;
      line-height: 2rem;
      font-weight: bold;

      max-width: calc(100% - 2rem);
      height: 2rem;
      overflow: visible;
      overflow-wrap: break-word;
      text-align: center;
    }
    span#current-word::after {
      content: "";

      height: 2.5rem;
      width: 0.2rem;
      background-color: var(--yellow);

      position: absolute;
      right: -0.3rem;
      top: 50%;
      transform: translateY(-50%);

      animation: pulse 1s step-end infinite;
    }

    div#buttons {
      --height: 6rem;
      --width: calc(var(--height) * 1.1547);

      position: relative;
      padding: 2rem 0;
      height: calc(var(--height) * 4);
    }

    button.letter {
      --gap: 0.5rem;
      --offsetX: 0px;
      --offsetY: 0px;


      position: absolute;
      top: 50%;
      left: 50%;

      transform: translate(calc(-50% + var(--offsetX)), calc(-50% + var(--offsetY)));
      
      width: var(--width);
      height: var(--height);
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);

      appearance: none;
      border: none;
      outline: none;

      background-color: var(--gray);
      color: var(--black);
      cursor: pointer;
      font-size: 2rem;
      font-weight: bold;
    }

    button#letter-1 {
      --offsetY: calc(-1 * (var(--height) + var(--gap)));
    }
    button#letter-2 {
      --offsetY: calc(-0.5 * (var(--height) + var(--gap)));
      --offsetX: calc(-0.75 * (var(--width) + var(--gap)));
    }
    button#letter-3 {
      --offsetY: calc(0.5 * (var(--height) + var(--gap)));
      --offsetX: calc(-0.75 * (var(--width) + var(--gap)));
    }
    button#letter-4 {
      background-color: var(--yellow);
    }
    button#letter-5 {
      --offsetY: calc(-0.5 * (var(--height) + var(--gap)));
      --offsetX: calc(0.75 * (var(--width) + var(--gap)));
    }
    button#letter-6 {
      --offsetY: calc(0.5 * (var(--height) + var(--gap)));
      --offsetX: calc(0.75 * (var(--width) + var(--gap)));
    }
    button#letter-7 {
      --offsetY: calc(1 * (var(--height) + var(--gap)));
    }
    
    div#actions {
      display: flex;
      align-items: flex-start;
      justify-content: center;

      padding-top: 1rem;
    }

    div#actions-inner {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    #more-categories,
    #yesterday-categories {
      display: flex;
      flex-flow: column nowrap;
      gap: 0.5rem;
    }

    #more-words,
    #yesterday-words {
      display: flex;
      flex-flow: row wrap;
      gap: 0.5rem;
    }

    @keyframes pulse {
      0% {
        opacity: 0;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <main id="container">
    <nav class="nav">
      <h1>BEE</h1>
      <button id="yesterday-button" class="white button">Yesterday</button>
    </nav>
    <header id="score">
      <div class="icon-group">
        <svg width="22" height="23" viewBox="0 0 22 23" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.125 17.6875H6.875M15.125 17.6875C15.8543 17.6875 16.5538 17.9772 17.0695 18.493C17.5853 19.0087 17.875 19.7082 17.875 20.4375H4.125C4.125 19.7082 4.41473 19.0087 4.93045 18.493C5.44618 17.9772 6.14565 17.6875 6.875 17.6875M15.125 17.6875V14.5938C15.125 14.0245 14.6639 13.5625 14.0937 13.5625H13.2953M6.875 17.6875V14.5938C6.875 14.0245 7.337 13.5625 7.90625 13.5625H8.70558M13.2953 13.5625H8.70558M13.2953 13.5625C12.7805 12.6733 12.4728 11.6794 12.3952 10.6548M8.70558 13.5625C9.22012 12.6732 9.5275 11.6793 9.60483 10.6548M12.3952 10.6548C13.3191 10.4416 14.1805 10.0181 14.9142 9.41733M12.3952 10.6548C11.4771 10.8666 10.5229 10.8666 9.60483 10.6548M9.60483 10.6548C8.68119 10.4415 7.8192 10.018 7.08583 9.41733M4.8125 4.383C3.91233 4.51408 3.02133 4.67358 2.1395 4.85967C2.34391 6.05939 2.94028 7.1575 3.83528 7.98218C4.73028 8.80685 5.87342 9.31156 7.08583 9.41733M4.8125 4.383V4.625C4.8125 6.55733 5.698 8.2825 7.08583 9.41733M4.8125 4.383V2.99425C6.83466 2.70917 8.90083 2.5625 11 2.5625C13.1001 2.5625 15.1662 2.70917 17.1875 2.99333V4.383M17.1875 4.383V4.625C17.1875 6.55733 16.302 8.2825 14.9142 9.41733M17.1875 4.383C18.0834 4.51335 18.9748 4.67232 19.8605 4.85967C19.6561 6.05925 19.0599 7.15725 18.1651 7.98191C17.2703 8.80657 16.1264 9.31137 14.9142 9.41733" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>          
        <span>
          <strong id="score-category">Beginner</strong> (<span id="score-total">0 points</span>)
        </span>      
      </div>
      <div id="next-category-group" class="icon-group">
        <svg width="22" height="23" viewBox="0 0 22 23" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.0625 17L8.25 10.8125L12.1972 14.7606C13.3382 12.5109 15.2207 10.7239 17.5267 9.7015L20.0383 8.58316M20.0383 8.58316L14.5933 6.49316M20.0383 8.58316L17.9483 14.0291" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>                 
        <span>
          <span id="score-to-next-category">0</span> to <strong id="next-category">Novice</strong></span>
        </span>      
      </div>
      <button id="more-button" class="small gray button">More</button>
    </header>
    <section id="game">
      <div id="input">
        <span id="feedback"></span>
        <span id="current-word"></span>
      </div>
      <div id="buttons">
        <button id="letter-1" class="letter">—</button>
        <button id="letter-2" class="letter">—</button>
        <button id="letter-3" class="letter">—</button>
        <button id="letter-4" class="letter">—</button>
        <button id="letter-5" class="letter">—</button>
        <button id="letter-6" class="letter">—</button>
        <button id="letter-7" class="letter">—</button>
      </div>
      <div id="actions">
        <div id="actions-inner">
          <button id="delete" class="white button">
            <svg width="22" height="23" viewBox="0 0 22 23" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M11 9.4375L13.0625 11.5M13.0625 11.5L15.125 13.5625M13.0625 11.5L15.125 9.4375M13.0625 11.5L11 13.5625M8.635 18.0725L2.79125 12.2288C2.59813 12.0354 2.48965 11.7733 2.48965 11.5C2.48965 11.2267 2.59813 10.9646 2.79125 10.7713L8.635 4.9275C8.82841 4.73408 9.0915 4.625 9.36466 4.625H17.875C18.422 4.625 18.9466 4.8423 19.3334 5.22909C19.7202 5.61589 19.9375 6.14049 19.9375 6.6875V16.3125C19.9375 16.8595 19.7202 17.3841 19.3334 17.7709C18.9466 18.1577 18.422 18.375 17.875 18.375H9.36466C9.0915 18.375 8.82841 18.2659 8.635 18.0725Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>                     
          </button>
          <button id="shuffle" class="white button">
            <svg width="22" height="23" viewBox="0 0 22 23" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.6877 9.06901H19.2637L16.3478 6.15126C15.4091 5.21247 14.2397 4.53737 12.9573 4.19381C11.6749 3.85026 10.3246 3.85036 9.04225 4.1941C7.75989 4.53785 6.59061 5.21313 5.65198 6.15205C4.71335 7.09098 4.03843 8.26046 3.69508 9.54292M2.73625 18.507V13.931M2.73625 13.931H7.31225M2.73625 13.931L5.65125 16.8488C6.59002 17.7875 7.75939 18.4626 9.04181 18.8062C10.3242 19.1498 11.6745 19.1497 12.9568 18.8059C14.2392 18.4622 15.4085 17.7869 16.3471 16.848C17.2857 15.909 17.9607 14.7396 18.304 13.4571M19.2637 4.49301V9.06717" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>                       
          </button>
          <button id="submit" class="yellow button">Submit</button>
        </div>
      </div>
    </section>
  </main>

  <dialog id="yesterday-dialog" class="dialog">
    <div class="nav">
      <h1>Yesterday's Stats</h1>
      <button id="yesterday-close-button" class="gray button">Close</button>
    </div>
    <div class="two-pane">
      <div class="two-pane-pane">
        <div class="icon-group">
          <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.125 17.1875H6.875M15.125 17.1875C15.8543 17.1875 16.5538 17.4772 17.0695 17.993C17.5853 18.5087 17.875 19.2082 17.875 19.9375H4.125C4.125 19.2082 4.41473 18.5087 4.93045 17.993C5.44618 17.4772 6.14565 17.1875 6.875 17.1875M15.125 17.1875V14.0938C15.125 13.5245 14.6639 13.0625 14.0937 13.0625H13.2953M6.875 17.1875V14.0938C6.875 13.5245 7.337 13.0625 7.90625 13.0625H8.70558M13.2953 13.0625H8.70558M13.2953 13.0625C12.7805 12.1733 12.4728 11.1794 12.3952 10.1548M8.70558 13.0625C9.22012 12.1732 9.5275 11.1793 9.60483 10.1548M12.3952 10.1548C13.3191 9.9416 14.1805 9.51812 14.9142 8.91733M12.3952 10.1548C11.4771 10.3666 10.5229 10.3666 9.60483 10.1548M9.60483 10.1548C8.68119 9.94147 7.8192 9.518 7.08583 8.91733M4.8125 3.883C3.91233 4.01408 3.02133 4.17358 2.1395 4.35967C2.34391 5.55939 2.94028 6.6575 3.83528 7.48218C4.73028 8.30685 5.87342 8.81156 7.08583 8.91733M4.8125 3.883V4.125C4.8125 6.05733 5.698 7.7825 7.08583 8.91733M4.8125 3.883V2.49425C6.83466 2.20917 8.90083 2.0625 11 2.0625C13.1001 2.0625 15.1662 2.20917 17.1875 2.49333V3.883M17.1875 3.883V4.125C17.1875 6.05733 16.302 7.7825 14.9142 8.91733M17.1875 3.883C18.0834 4.01335 18.9748 4.17232 19.8605 4.35967C19.6561 5.55925 19.0599 6.65725 18.1651 7.48191C17.2703 8.30657 16.1264 8.81137 14.9142 8.91733" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>            
          <strong><span id="yesterday-categories-total">0 points</span> / <span id="yesterday-categories-max">0</span></strong>
        </div>
        <div id="yesterday-categories" class="two-pane-pane-inner">

        </div>
      </div>
      <div class="two-pane-pane">
        <div class="icon-group">
          <svg width="23" height="22" viewBox="0 0 23 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.375 7.5625H15.625M7.375 10.3125H11.5M2.5625 11.6967C2.5625 13.1633 3.59192 14.4412 5.04392 14.6548C6.07883 14.8069 7.12475 14.9233 8.18167 15.0022C8.5025 15.026 8.79583 15.1947 8.97458 15.4614L11.5 19.25L14.0254 15.4614C14.114 15.3297 14.2315 15.2198 14.3689 15.1403C14.5062 15.0607 14.66 15.0135 14.8183 15.0022C15.8681 14.9238 16.9146 14.8079 17.9561 14.6548C19.4081 14.4412 20.4375 13.1643 20.4375 11.6958V6.17925C20.4375 4.71075 19.4081 3.43384 17.9561 3.22025C15.8184 2.90649 13.6606 2.74932 11.5 2.75C9.30733 2.75 7.15133 2.91042 5.04392 3.22025C3.59192 3.43384 2.5625 4.71167 2.5625 6.17925V11.6958V11.6967Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>            
          <strong><span id="yesterday-words-total">0 words</span> / <span id="yesterday-words-max">0</span></strong>
        </div>
        <div id="yesterday-words" class="two-pane-pane-inner">

        </div>
      </div>
    </div>
  </dialog>
  
  <dialog id="more-dialog" class="dialog">
    <div class="nav">
      <h1>Detailed Stats</h1>
      <button id="more-close-button" class="gray button">Close</button>
    </div>
    <div class="two-pane">
      <div class="two-pane-pane">
        <div class="icon-group">
          <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.125 17.1875H6.875M15.125 17.1875C15.8543 17.1875 16.5538 17.4772 17.0695 17.993C17.5853 18.5087 17.875 19.2082 17.875 19.9375H4.125C4.125 19.2082 4.41473 18.5087 4.93045 17.993C5.44618 17.4772 6.14565 17.1875 6.875 17.1875M15.125 17.1875V14.0938C15.125 13.5245 14.6639 13.0625 14.0937 13.0625H13.2953M6.875 17.1875V14.0938C6.875 13.5245 7.337 13.0625 7.90625 13.0625H8.70558M13.2953 13.0625H8.70558M13.2953 13.0625C12.7805 12.1733 12.4728 11.1794 12.3952 10.1548M8.70558 13.0625C9.22012 12.1732 9.5275 11.1793 9.60483 10.1548M12.3952 10.1548C13.3191 9.9416 14.1805 9.51812 14.9142 8.91733M12.3952 10.1548C11.4771 10.3666 10.5229 10.3666 9.60483 10.1548M9.60483 10.1548C8.68119 9.94147 7.8192 9.518 7.08583 8.91733M4.8125 3.883C3.91233 4.01408 3.02133 4.17358 2.1395 4.35967C2.34391 5.55939 2.94028 6.6575 3.83528 7.48218C4.73028 8.30685 5.87342 8.81156 7.08583 8.91733M4.8125 3.883V4.125C4.8125 6.05733 5.698 7.7825 7.08583 8.91733M4.8125 3.883V2.49425C6.83466 2.20917 8.90083 2.0625 11 2.0625C13.1001 2.0625 15.1662 2.20917 17.1875 2.49333V3.883M17.1875 3.883V4.125C17.1875 6.05733 16.302 7.7825 14.9142 8.91733M17.1875 3.883C18.0834 4.01335 18.9748 4.17232 19.8605 4.35967C19.6561 5.55925 19.0599 6.65725 18.1651 7.48191C17.2703 8.30657 16.1264 8.81137 14.9142 8.91733" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>               
          <strong id="more-categories-total">0 points</strong>
        </div>
        <div id="more-categories" class="two-pane-pane-inner">

        </div>
      </div>
      <div class="two-pane-pane">
        <div class="icon-group">
          <svg width="23" height="22" viewBox="0 0 23 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.375 7.5625H15.625M7.375 10.3125H11.5M2.5625 11.6967C2.5625 13.1633 3.59192 14.4412 5.04392 14.6548C6.07883 14.8069 7.12475 14.9233 8.18167 15.0022C8.5025 15.026 8.79583 15.1947 8.97458 15.4614L11.5 19.25L14.0254 15.4614C14.114 15.3297 14.2315 15.2198 14.3689 15.1403C14.5062 15.0607 14.66 15.0135 14.8183 15.0022C15.8681 14.9238 16.9146 14.8079 17.9561 14.6548C19.4081 14.4412 20.4375 13.1643 20.4375 11.6958V6.17925C20.4375 4.71075 19.4081 3.43384 17.9561 3.22025C15.8184 2.90649 13.6606 2.74932 11.5 2.75C9.30733 2.75 7.15133 2.91042 5.04392 3.22025C3.59192 3.43384 2.5625 4.71167 2.5625 6.17925V11.6958V11.6967Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>            
          <strong id="more-words-total">0 words</strong>
        </div>
        <div id="more-words" class="two-pane-pane-inner">

        </div>
      </div>
    </div>
  </dialog>
</body>
<script>
  const Constants = {
    Api: {
      Today: "https://freebee.fun/cgi-bin/today",
    },
    Maps: {
      CategoryPercentageMap: {
        "Newbie": 0.00,
        "Novice": 0.02,
        "Fine": 0.05,
        "Skilled": 0.08,
        "Excellent": 0.15,
        "Superb": 0.25,
        "Marvellous": 0.40,
        "Outstanding": 0.50,
        "Queen Bee": 0.70,
      },
      // 0-indexed
      WordLengthScoreMap: [
        0,
        0,
        0,
        0,
        1, // scoring starts at 4
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14,
        15,
      ]
    }
  };

  const AppState = {
    now: undefined,
    yesterday: undefined,

    currentGameKey: undefined,
    hasHistory: false,
    hasYesterday: false,
  };

  let GameHistory = {};
  let GameState = {};

  const Bindings = {
    Control: {
      YesterdayButton: {
        Element: document.getElementById("yesterday-button"),
        Listener: undefined,
      },
      YesterdayCloseButton: {
        Element: document.getElementById("yesterday-close-button"),
        Listener: undefined,
      },
      MoreButton: {
        Element: document.getElementById("more-button"),
        Listener: undefined,
      },
      MoreCloseButton: {
        Element: document.getElementById("more-close-button"),
        Listener: undefined,
      },
    },
    Dialogs: {
      MoreDialog: document.getElementById("more-dialog"),
      MoreCategoriesTotal: document.getElementById("more-categories-total"),
      MoreCategories: document.getElementById("more-categories"),
      MoreWordsTotal: document.getElementById("more-words-total"),
      MoreWords: document.getElementById("more-words"),

      YesterdayDialog: document.getElementById("yesterday-dialog"),
      YesterdayCategoriesTotal: document.getElementById("yesterday-categories-total"),
      YesterdayCategoriesMax: document.getElementById("yesterday-categories-max"),
      YesterdayCategories: document.getElementById("yesterday-categories"),
      YesterdayWordsTotal: document.getElementById("yesterday-words-total"),
      YesterdayWordsMax: document.getElementById("yesterday-words-max"),
      YesterdayWords: document.getElementById("yesterday-words"),
    },
    Score: {
      ScoreCategory: document.getElementById("score-category"),
      ScoreTotal: document.getElementById("score-total"),
      ScoreToNextCategory: document.getElementById("score-to-next-category"),
      NextCategory: document.getElementById("next-category"),
      NextCategoryGroup: document.getElementById("next-category-group"),
    },
    Word: {
      Feedback: document.getElementById("feedback"),
      CurrentWord: document.getElementById("current-word"),
    },
    Interactive: {
      Center: {
        Element: document.getElementById("letter-4"),
        Listener: undefined,
      },
      Letters: [
        {
          Element: document.getElementById("letter-1"),
          Listener: undefined,
        },
        {
          Element: document.getElementById("letter-2"),
          Listener: undefined,
        },
        {
          Element: document.getElementById("letter-3"),
          Listener: undefined,
        },
        {
          Element: document.getElementById("letter-5"),
          Listener: undefined,
        },
        {
          Element: document.getElementById("letter-6"),
          Listener: undefined,
        },
        {
          Element: document.getElementById("letter-7"),
          Listener: undefined,
        },
      ],
    },
    Actions: {
      Delete: {
        Element: document.getElementById("delete"),
        Listener: undefined,
      },
      Shuffle: {
        Element: document.getElementById("shuffle"),
        Listener: undefined,
      },
      Submit: {
        Element: document.getElementById("submit"),
        Listener: undefined,
      },
    }
  };

  const switchGame = (gameKey) => {
    AppState.currentGameKey = gameKey;
    GameState = GameHistory[AppState.currentGameKey];
    updateDisplayState();
  }

  const load = async () => {
    const now = new Date(Date.now() - 3 * 60 * 60 * 1000).toLocaleDateString("en-CA");
    const yesterday = new Date(Date.now() - (24 + 3) * 60 * 60 * 1000).toLocaleDateString("en-CA");
    const localDataString = window.localStorage.getItem("bee_History");

    if (localDataString) {
      GameHistory = JSON.parse(localDataString);
    }

    if (!GameHistory[now]) {
      const response = await fetch(Constants.Api.Today);
      const game = await response.json();

      GameHistory[now] = {
        date: now,
        game,
        score: 0,
        currentWord: "",
        feedback: "",
        words: [],
        CategoryPointsMap: Object.fromEntries(Object.entries(Constants.Maps.CategoryPercentageMap).map(([category, percentage]) => [category, Math.floor(percentage * game.total)])),
      };
    }
    
    Object.assign(AppState, {
      now,
      yesterday,

      hasHistory: Object.keys(GameHistory).length > 1,
      hasYesterday: yesterday in GameHistory,
    });
    switchGame(now);
  };

  const save = async () => {
    window.localStorage.setItem("bee_History", JSON.stringify(GameHistory));
  }

  const updateDisplayState = () => {
    updateButtonActions();

    let currentCategory = undefined;
    let nextCategory = undefined;
    let pointsToNextCategory = 0;
    
    for (const [category, points] of Object.entries(GameState.CategoryPointsMap)) {
      if (points > GameState.score) {
        nextCategory = category;
        pointsToNextCategory = points - GameState.score;
        break;
      } else {
        currentCategory = category;
      }
    };

    Bindings.Score.ScoreCategory.textContent = currentCategory;
    Bindings.Score.ScoreTotal.textContent = `${GameState.score} point${GameState.score === 1 ? "" : "s"}`;
    Bindings.Score.ScoreToNextCategory.textContent = pointsToNextCategory;
    Bindings.Score.NextCategory.textContent = nextCategory;
    Bindings.Score.NextCategoryGroup.style.setProperty("display", nextCategory ? "flex" : "none");

    Bindings.Word.Feedback.textContent = GameState.feedback;
    Bindings.Word.CurrentWord.innerHTML = GameState.currentWord.toLocaleUpperCase().split("").reduce((innerHTML, letter) =>
      innerHTML += `<span${letter === GameState.game.center.toLocaleUpperCase() ? ' class="yellow-color"' : ""}>${letter}</span>`,
      ""
    );

    Bindings.Control.YesterdayButton.Element.style.setProperty("display", AppState.hasYesterday ? "block" : "none");

    Bindings.Dialogs.MoreCategoriesTotal.textContent = `${GameState.score} point${GameState.score === 1 ? "" : "s"}`;
    Bindings.Dialogs.MoreCategories.innerHTML = Object.entries(GameState.CategoryPointsMap).reduce((innerHTML, [category, points]) => 
      innerHTML += `<span${category === currentCategory ? ' class="yellow"' : ""}><strong>${category}</strong> (${points}  point${points === 1 ? "" : "s"})</span>`,
      ""
    );
    Bindings.Dialogs.MoreWordsTotal.textContent = `${GameState.words.length} word${GameState.words.length === 1 ? "" : "s"}`;
    Bindings.Dialogs.MoreWords.innerHTML = GameState.words.reduce((innerHTML, word) => innerHTML += `<span class="gray">${word}</span>`, "");

    if (AppState.hasYesterday) {
      const YesterdayState = GameHistory[AppState.yesterday];
      
      let yesterdayCategory = undefined;
      
      for (const [category, points] of Object.entries(YesterdayState.CategoryPointsMap)) {
        if (points <= YesterdayState.score) {
          yesterdayCategory = category;
        }
      };

      Bindings.Dialogs.YesterdayCategoriesTotal.textContent = `${YesterdayState.score} point${YesterdayState.score === 1 ? "" : "s"}`;
      Bindings.Dialogs.YesterdayCategoriesMax.textContent = YesterdayState.game.total;
      Bindings.Dialogs.YesterdayCategories.innerHTML = Object.entries(YesterdayState.CategoryPointsMap).reduce((innerHTML, [category, points]) => 
        innerHTML += `<span${category === yesterdayCategory ? ' class="yellow"' : ""}><strong>${category}</strong> (${points}  point${points === 1 ? "" : "s"})</span>`,
        ""
      );
      Bindings.Dialogs.YesterdayWordsTotal.textContent = `${YesterdayState.words.length} word${YesterdayState.words.length === 1 ? "" : "s"}`;
      Bindings.Dialogs.YesterdayWordsMax.textContent = YesterdayState.game.wordlist.length;
      Bindings.Dialogs.YesterdayWords.innerHTML = YesterdayState.game.wordlist.reduce((innerHTML, word) => innerHTML += `<span class="${YesterdayState.words.includes(word) ? "yellow" : "gray"}">${word}</span>`, "");
    }

    save();
  }

  const updateBinding = (binding, callback) => {
    binding.Element.removeEventListener("pointerdown", binding.Listener);
    binding.Listener = callback;
    binding.Element.addEventListener("pointerdown", binding.Listener);
  };

  const updateButtonActions = () => {
    Bindings.Interactive.Center.Element.textContent = GameState.game.center.toLocaleUpperCase();
    updateBinding(Bindings.Interactive.Center, () => {
      if (GameState.feedback) {
        GameState.currentWord = GameState.game.center;
        GameState.feedback = "";
        } else if (GameState.currentWord.length > 15) {
          GameState.feedback = "Word too long.";
        } else {
        GameState.currentWord += GameState.game.center;
      }
      updateDisplayState();
    });

    for (const [index, letter] of GameState.game.letters.split("").entries()) {
      Bindings.Interactive.Letters[index].Element.textContent = letter.toLocaleUpperCase();
      updateBinding(Bindings.Interactive.Letters[index], () => {
        if (GameState.feedback) {
          GameState.currentWord = letter;
          GameState.feedback = "";
        } else if (GameState.currentWord.length > 15) {
          GameState.feedback = "Word too long.";
        } else {
          GameState.currentWord += letter;
        }
        updateDisplayState();
      });
    };

    updateBinding(Bindings.Actions.Delete, () => {
      if (GameState.feedback) {
        GameState.currentWord = "";
        GameState.feedback = "";
      } else if (GameState.currentWord.length > 15) {
        GameState.feedback = "Word too long.";
      } else {
        GameState.currentWord = GameState.currentWord.slice(0, -1);
      }
      updateDisplayState();
    });

    updateBinding(Bindings.Actions.Shuffle, () => {
      Bindings.Interactive.Letters = Bindings.Interactive.Letters
        .map(value => ({ value, sort: Math.random() }))
        .sort((a, b) => a.sort - b.sort)
        .map(({ value }) => value);
      updateDisplayState();
    });

    updateBinding(Bindings.Actions.Submit, () => {
      const word = GameState.currentWord;

      if (GameState.game.wordlist.includes(word)) {
        if (GameState.words.includes(word)) {
          GameState.feedback = "Word already found.";
        } else {
          const isPangram = `${GameState.game.letters}${GameState.game.center}`.split("").every(letter => word.includes(letter));
          const score = Constants.Maps.WordLengthScoreMap[word.length] + (isPangram ? 7 : 0);

          GameState.score += score;
          GameState.words.push(word);
          GameState.words.sort();
          GameState.feedback = `${isPangram ? "Pangram!" : "Nice!"} (${score} point${score === 1 ? "" : "s"})`;
        }
      } else {
        if (word.length <= 3) {
          GameState.feedback = "Word is too short.";
        } else if (!word.includes(GameState.game.center)) {
          GameState.feedback = "Center letter is missing.";
        } else {
          GameState.feedback = "Not a valid word.";
        }
      }

      updateDisplayState();
    });
  };

  const updateControlButtonsOnce = () => {
    updateBinding(Bindings.Control.MoreButton, () => {
      Bindings.Dialogs.MoreDialog.showModal();
    });
    updateBinding(Bindings.Control.MoreCloseButton, () => {
      Bindings.Dialogs.MoreDialog.close();
    });
    
    updateBinding(Bindings.Control.YesterdayButton, () => {
      Bindings.Dialogs.YesterdayDialog.showModal();
    });
    updateBinding(Bindings.Control.YesterdayCloseButton, () => {
      Bindings.Dialogs.YesterdayDialog.close();
    });
  }

  const play = async () => {
    await load();

    updateControlButtonsOnce();

    if ('serviceWorker' in navigator) {
      await navigator.serviceWorker.register('./sw.js', {
        scope: "/"
      });
    }
  };

  play();
</script>
</html>